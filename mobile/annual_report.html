{% extends 'mobile/layout.html' %}
{% block title %}年度报告 - 阳光记账{% endblock %}
{% block page_title %}年度报告{% endblock %}

{% block content %}
<div class="report-container-mobile">
    <!-- Year Selector -->
    <form id="year-selector-form-mobile" method="get" action="{{ url_for('annual_report') }}">
        <select name="year" onchange="this.form.submit();">
            {% if not all_years %}<option>{{ selected_year }}</option>{% endif %}
            {% for year in all_years %}
                <option value="{{ year }}" {% if year == selected_year %}selected{% endif %}>{{ year }}年报告</option>
            {% endfor %}
        </select>
    </form>

    {% if selected_year and (total_income > 0 or total_expense > 0) %}
        <!-- Summary Card -->
        <div class="card-mobile report-summary-card">
            <h3>{{ selected_year }}年财务概览</h3>
            <div class="metric-item">
                <span>总收入</span>
                <strong class="income">+ ¥{{ '%.2f'|format(total_income) }}</strong>
            </div>
            <div class="metric-item">
                <span>总支出</span>
                <strong class="expense">- ¥{{ '%.2f'|format(total_expense) }}</strong>
            </div>
            <div class="metric-item">
                <span>净结余</span>
                <strong>¥{{ '%.2f'|format(total_balance) }}</strong>
            </div>
        </div>

        <!-- Chart Card -->
        <div class="card-mobile chart-card-mobile">
            <h3>月度收支趋势</h3>
            <div class="chart-wrapper-mobile">
                <canvas id="trendsChart"></canvas>
            </div>
        </div>

        <!-- AI Summary Card -->
        <div class="card-mobile">
             <h3>✨ 智能摘要</h3>
             <p class="summary-text">{{ ai_summary }}</p>
        </div>

        <!-- Top 5 Categories Card -->
        <div class="card-mobile">
            <h3>Top 5 支出类别</h3>
            {% if top_expense_categories %}
            <ul class="top-categories-list-mobile">
                {% for cat, amount in top_expense_categories %}
                <li>
                    <span>{{ cat }}</span>
                    <span class="expense">- ¥{{ '%.2f'|format(amount) }}</span>
                </li>
                {% endfor %}
            </ul>
            {% else %}
            <p class="no-data-placeholder">无支出分类数据</p>
            {% endif %}
        </div>
    {% else %}
        <div class="no-data-placeholder card-mobile">
            <h2>该年度无数据</h2>
            <p>请尝试选择其他年份。</p>
        </div>
    {% endif %}
</div>

{% if selected_year and (total_income > 0 or total_expense > 0) %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const trendsCtx = document.getElementById('trendsChart');
    if (!trendsCtx) return;

    Chart.defaults.font.family = "Noto Sans SC, sans-serif";
    Chart.defaults.color = '#555';

    const monthlyTrends = {{ monthly_trends|tojson|safe }};
    const labels = Object.keys(monthlyTrends).sort();
    const incomeData = labels.map(label => monthlyTrends[label].income || 0);
    const expenseData = labels.map(label => monthlyTrends[label].expense || 0);

    new Chart(trendsCtx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: '收入',
                data: incomeData,
                backgroundColor: 'rgba(28, 177, 69, 0.8)',
                borderRadius: 4
            }, {
                label: '支出',
                data: expenseData,
                backgroundColor: 'rgba(239, 68, 68, 0.8)',
                borderRadius: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: { y: { beginAtZero: true }, x: { grid: { display: false } } },
            plugins: { legend: { display: false }, tooltip: { } }
        }
    });
});
</script>
{% endif %}
{% endblock %}
