{% extends 'mobile/layout.html' %}

{# --- 页面标题 --- #}
{% block title %}{% if record %}编辑记录{% else %}添加记录{% endif %}{% endblock %}
{% block page_title %}{% if record %}编辑记录{% else %}添加记录{% endif %}{% endblock %}


{% block content %}
<div class="content-card form-card">
    <form action="{{ url_for('edit_record', record_id=record.id) if record else url_for('add_record') }}" method="post" class="modern-form">
        
        <!-- 支出/收入选择器 -->
        <div class="type-segmented-control">
            <input type="radio" id="type_expense" name="type" value="expense" {% if not record or record.type == 'expense' %}checked{% endif %}>
            <label for="type_expense" class="tab-expense">支出</label>
            <input type="radio" id="type_income" name="type" value="income" {% if record and record.type == 'income' %}checked{% endif %}>
            <label for="type_income" class="tab-income">收入</label>
        </div>

        <!-- 金额 -->
        <div class="form-group">
            <label for="amount">金额 (¥)</label>
            <input type="number" step="0.01" id="amount" name="amount" placeholder="0.00" value="{{ record.amount if record else '' }}" required>
        </div>

        <!-- 类别选择（支持自定义） -->
        <div class="form-group">
            <label for="category">类别</label>
            <select id="category" name="category" required>
                <!-- JS will populate this -->
            </select>
        </div>
        
        <!-- 自定义类别输入框 (默认隐藏) -->
        <div class="form-group" id="custom-category-wrapper" style="display: none;">
            <label for="custom-category-input">自定义类别名称</label>
            <input type="text" id="custom-category-input" name="custom_category_input" placeholder="输入一次性类别">
        </div>
        
        <!-- 日期与备注 -->
        <div class="form-row">
            <div class="form-group">
                <label for="date">日期</label>
                <!-- 【核心修改】在添加时使用新日期变量，编辑时使用记录自己的日期 -->
                <input type="date" id="date" name="date" value="{{ record.date if record else date_for_new_record }}">
            </div>
            <div class="form-group">
                <label for="description">备注</label>
                <input type="text" id="description" name="description" value="{{ record.description if record else '' }}" placeholder="可选">
            </div>
        </div>
        
        <button type="submit" class="btn-submit">{% if record %}保存更改{% else %}确认记账{% endif %}</button>
        
        {% if record %}
        <a href="javascript:history.back()" class="btn-cancel">返回</a>
        {% endif %}
    </form>
</div>

{# --- JavaScript逻辑大升级 --- #}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const typeRadios = document.querySelectorAll('input[name="type"]');
    const categorySelect = document.getElementById('category');
    const customCategoryWrapper = document.getElementById('custom-category-wrapper');
    const customCategoryInput = document.getElementById('custom-category-input');

    const categories = {
        expense: {{ default_expense_categories | tojson | safe }},
        income: {{ default_income_categories | tojson | safe }}
    };

    const currentCategory = "{{ record.category if record else '' }}";
    // 检查当前记录的分类是否是预设分类
    const isCurrentCategoryPreset = categories.expense.includes(currentCategory) || categories.income.includes(currentCategory);

    function updateCategories() {
        const selectedType = document.querySelector('input[name="type"]:checked').value;
        const categoryList = categories[selectedType];
        
        categorySelect.innerHTML = ''; // 清空旧选项
        
        // 动态创建新选项
        categoryList.forEach(function(category) {
            const option = document.createElement('option');
            option.value = category;
            option.textContent = category;
            categorySelect.appendChild(option);
        });

        // 【核心】添加“手动输入”选项
        const customOption = document.createElement('option');
        customOption.value = '--custom--';
        customOption.textContent = '手动输入...';
        categorySelect.appendChild(customOption);
        
        // --- 智能回显逻辑 ---
        if (currentCategory) {
            if (isCurrentCategoryPreset) {
                // 如果是预设分类，直接选中
                categorySelect.value = currentCategory;
            } else {
                // 如果不是预设分类（说明它就是个自定义的），则选中“手动输入”并显示输入框和值
                categorySelect.value = '--custom--';
                customCategoryWrapper.style.display = 'block';
                customCategoryInput.value = currentCategory;
                customCategoryInput.required = true;
            }
        }
    }

    // --- 事件监听 ---
    categorySelect.addEventListener('change', function() {
        if (this.value === '--custom--') {
            customCategoryWrapper.style.display = 'block';
            customCategoryInput.required = true; // 设为必填
            customCategoryInput.focus();
        } else {
            customCategoryWrapper.style.display = 'none';
            customCategoryInput.required = false; // 取消必填
            customCategoryInput.value = ''; // 清空值
        }
    });

    typeRadios.forEach(function(radio) {
        radio.addEventListener('change', updateCategories);
    });

    // 页面加载时立即执行一次
    updateCategories();
});
</script>
{% endblock %}
